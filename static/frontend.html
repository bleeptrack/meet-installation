<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Localized Website</title>
    <script src="/socket.io/socket.io.js"></script>
    <script type="importmap">
    {
      "imports": {
        "i18next": "/node_modules/i18next/dist/esm/i18next.js",
        "i18next-browser-languagedetector": "/node_modules/i18next-browser-languagedetector/dist/esm/i18nextBrowserLanguageDetector.js",
        "i18next-http-backend": "/node_modules/i18next-http-backend/esm/index.js"
      }
    }
    </script>
    <script type="module" src="/js/i18n.js"></script>
    <script type="module" src="/js/language-switcher.js"></script>
    <script type="module" src="/js/UsernameChooser.js"></script>
    <script type="module" src="/js/Questions.js"></script>
    <script type="module" src="/js/TarotCard.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .content {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <language-switcher></language-switcher>
    <div id="username"></div>
    <main>
        <p id="waitingForStart">Just a moment...</p>
    </main>

    <script type="module">
        import i18next from 'i18next';
        import { t, i18nPromise } from '/js/i18n.js';

        // Wait for i18next to initialize before setting up the application
        i18nPromise.then(() => {
            // Create a single socket instance and make it available globally
            window.socket = io();
            
            // Apply initial translations
            document.querySelector('#waitingForStart').textContent = t('waitingForStart');
            
            window.socket.on('connect', () => {
                console.log('Connected to server');
                // If we have a stored username, automatically reconnect with it
                const storedUsername = localStorage.getItem('username');
                if (storedUsername) {
                    window.socket.emit('action:username', storedUsername);
                    // Restore the last phase if it exists
                    const lastPhase = localStorage.getItem('lastPhase');
                    if (lastPhase) {
                        switch(lastPhase) {
                            case 'questions':
                                document.querySelector('main').innerHTML = '<questions-component></questions-component>';
                                break;
                            case 'results':
                                // We'll need to wait for the players data to show the correct card
                                break;
                            case 'grouping':
                                // We'll need to wait for the players data to show the correct group
                                break;
                        }
                    }
                }
            });

            window.socket.on('disconnect', () => {
                console.log('Disconnected from server');
            });

            window.socket.on('order:username', () => {
                document.querySelector('main').innerHTML = '<username-chooser></username-chooser>';
                localStorage.setItem('lastPhase', 'username');
            });

            window.socket.on('order:questions', () => {
                console.log("Received order:questions");
                document.querySelector('main').innerHTML = '<questions-component></questions-component>';
                localStorage.setItem('lastPhase', 'questions');
            });

            window.socket.on('order:results', (players) => {
                console.log("Received order:results");
                const username = localStorage.getItem('username');
                const currentPlayer = players.find(player => player.username === username);
                console.log("Current player:", currentPlayer);
                const pairIndex = currentPlayer.pairIndex;
                document.querySelector('main').innerHTML = `<tarot-card image-url="https://www.tarot.com/images/cards/the-fool.jpg" text="Pair ${pairIndex}"></tarot-card>`;
                localStorage.setItem('lastPhase', 'results');
            });

            window.socket.on('order:grouping', (players) => {
                console.log("Received order:grouping");
                const username = localStorage.getItem('username');
                const currentPlayer = players.find(player => player.username === username);
                console.log("Current player:", currentPlayer);
                const groupId = currentPlayer.groupId;
                const groupLetter = String.fromCharCode(65 + groupId); // Convert 0 to 'A', 1 to 'B', etc.
                document.querySelector('main').innerHTML = `<p>Group ${groupLetter}</p>`;
                localStorage.setItem('lastPhase', 'grouping');
            });

            // Clear phase when starting a new session
            window.socket.on('order:waiting', () => {
                localStorage.removeItem('lastPhase');
            });

            if (localStorage.getItem('username')) {
                document.querySelector('#username').innerHTML = localStorage.getItem('username');
            }

            // Update translations when language changes
            window.addEventListener('languageChanged', (event) => {
                document.querySelector('#waitingForStart').textContent = t('waitingForStart');
            });
        }).catch(error => {
            console.error('Failed to initialize i18next:', error);
        });
    </script>
</body>
</html>

